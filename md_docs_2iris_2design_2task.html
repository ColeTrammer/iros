<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.10.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iros: Task Model</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- ... other metadata & script includes ... -->
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeParagraphLink.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init();
    </script>
  </head>
  <body>
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">
                    Iros
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2iris_2design_2task.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Task Model</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md202"></a> </p>
<h1><a class="anchor" id="autotoc_md203"></a>
What is a task?</h1>
<p>In today's operating systems, the is a notion of processes and a notion of threads. Processes have isolated address spaces and resources, and each can have many threads.</p>
<p>A thread represent an executable instruction stream, and is the concept relevant to the scheduler. At all times, 1 task should be executing on 1 CPU core, unless the CPU itself is idle.</p>
<h1><a class="anchor" id="autotoc_md204"></a>
How is a process represented?</h1>
<p>In Linux, there is no kernel level structure representing a process. Instead, threads (called tasks) are grouped together by sharing attributes (like the memory region, PID, etc.). This has some consequences, because attributes which are not shared between tasks on Linux (euid, egid) but are shared between threads according to POSIX, must have their sharing be emulated in userspace.</p>
<p>In general, the whole process structure is essentially redundant, given almost all kernel operations should operate on threads and not processes. This includes signalling, blocking, scheduling, and tracing. Memory allocation can operate on a dedicated object which is shared between threads, as can process attributes (pid, pgid, sid, uid) if they are to be supported directly in the kernel. File system operations are more interesting, since they can be made more efficent by not allowing file sharing between threads (think io_uring registered files), but are expected to be shared by POSIX. This can be solved by introducing a kernel object representing a file table. Then, the runtime library will create a shared file table for each process, but <a class="el" href="classdius_1_1IoContext.html">dius::IoContext</a> can have its own private file table, which cannot be accessed by other threads.</p>
<p>Therefore, at least initially, there will be no notion of a process, only tasks. This contrasts the normal OSDEV approach, which only represents processes, not threads, and thus requires large design changes to support multi-threading.</p>
<h1><a class="anchor" id="autotoc_md205"></a>
How is a task represented?</h1>
<p>A task must all the information required to perform a context switch. This means it must store all relevant registers, which must be loaded when it comes to execute the task. In addition, some state variable is used to determine if a task is (running or blocked), although this notion is mostly useful for scheduling.</p>
<p>A task also contains ISA level information necessary to run programs on a given architecture. On x86_64, this includes the base address of the gs register, which stores the userspace thread-control-block which serves as the basis for the userspace threading implementation.</p>
<p>Tasks also require their own stack, which is a dedicated virtual memory region in the kernel which is used to service any interrupts or system calls which occur while the task is executing. Note this is not shared between processes, and so it is not part of the process virtual memory map.</p>
<p>Lastly, a task has some shared process state which includes the process virtual memory map.</p>
<h1><a class="anchor" id="autotoc_md206"></a>
Program Initialization ABI</h1>
<p>Userspace applications expect to receive their program arguments and enviornment variables from the kernel. This information is passed on the initial task's stack. Each string will be represented by a pointer-length pair as follows:</p>
<div class="fragment"><div class="line">+----------------------+</div>
<div class="line">| data: char*          |</div>
<div class="line">| length: usize        |</div>
<div class="line">+----------------------+</div>
</div><!-- fragment --><p>Although the length is provided, the data strings themselves are still null-terminated for compatibility with C. However, the data-length pair layout enables C++ applications to receive the arguments as string views.</p>
<p>The stack will contain many pairs of these string records, layed out in contiguously decreasing memory. The program receives the following arguments passed as a function would normally expect according to the platform's abi (so on x86_64, the arguments will be passed in <code>rdi</code>, <code>rsi</code>, etc.).</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Argument   </th><th class="markdownTableHeadNone">x86_64 Register   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">argv   </td><td class="markdownTableBodyNone"><code>rdi</code>   </td><td class="markdownTableBodyNone">A pointer to the argument strings, represented as pointer-length pairs    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">argc   </td><td class="markdownTableBodyNone"><code>rsi</code>   </td><td class="markdownTableBodyNone">The number of argument strings    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">envp   </td><td class="markdownTableBodyNone"><code>rdx</code>   </td><td class="markdownTableBodyNone">A pointer to the environment strings, represented as pointer-length pairs    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">envc   </td><td class="markdownTableBodyNone"><code>rcx</code>   </td><td class="markdownTableBodyNone">The number of enironment strings   </td></tr>
</table>
<p>This convention enables the userspace entry to point to parse the arguments and environment directly as a <code>di::Span&lt;di::StringView&gt;</code>, without the need to copy the strings or deal with null-termination.</p>
<p>Additionally, the kernel ensures the entry point can be written directly in C++, without requiring any assembly. To do this, the stack will be 16-byte aligned, and as described above, the program arguments will be passed using the normal calling convention.</p>
<p>In total, the stack on entry will be laid out as follows:</p>
<div class="fragment"><div class="line">+-------------------------------------+</div>
<div class="line">| padding to ensure 16-byte alignment |</div>
<div class="line">+-------------------------------------+</div>
<div class="line">| ...                                 |</div>
<div class="line">| null-terminated env strings         |</div>
<div class="line">| ...                                 |</div>
<div class="line">| null-terminated arg strings         |</div>
<div class="line">+-------------------------------------+ &lt;- envp + 2 * envc</div>
<div class="line">| ...                                 |</div>
<div class="line">| enviornemt data-length pairs        |</div>
<div class="line">+-------------------------------------+ &lt;- envp / argv + 2 * argc</div>
<div class="line">| ...                                 |</div>
<div class="line">| argument data-length pairs          |</div>
<div class="line">+-------------------------------------+ &lt;- argv</div>
<div class="line">| padding to ensure 16-byte alignment |</div>
<div class="line">+-------------------------------------+ &lt;- stack pointer on entry</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Iros Project Documentation</a></li><li class="navelem"><a class="el" href="md_docs_2iris_2table__of__contents.html">Iris Kernel Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>

<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.10.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iros: Synchronization Primitives</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- ... other metadata & script includes ... -->
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeParagraphLink.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init();
    </script>
  </head>
  <body>
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">
                    Iros
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2iris_2design_2synchronization.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Synchronization Primitives</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md182"></a> </p>
<h1><a class="anchor" id="autotoc_md183"></a>
Purpose</h1>
<p>Many functions within the kernel can be called from different context simultaneously. This can happen either because there are multiple processors running, because the kernel was pre-empted while executing the function in question for another task, or because a HW interrupt fired during the execution of said function.</p>
<p>To enable these scenarios to work properly, the kernel must have various synchronization primitives which ensure that scenarios like these are handled correctly.</p>
<h1><a class="anchor" id="autotoc_md184"></a>
Safety</h1>
<p>Different functions require different levels of synchronization safety depending on some pre-conditions which can be imposed on the caller. This mainly concerns what type of execution context is allowed to call the function in question.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Execution Context   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">HW Interrupt   </td><td class="markdownTableBodyNone">A function can safely be called inside a hardware interrupt handler    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Normal   </td><td class="markdownTableBodyNone">A function can be safely called by any kernel level task   </td></tr>
</table>
<p>The reason for this distinction is that functions which can be called within an HW interrupt handler <b>MUST</b> disable interrupts during their execution. If this does not occur, then a HW interrupt may fire during the function's execution, and when the hardware interrupt attempts to call said function, a deadlock will occur.</p>
<p>In contrast, functions which can never be called from interrupt context <em>should not</em> disable interrupts, to ensure the system is responsive.</p>
<h2><a class="anchor" id="autotoc_md185"></a>
Note on Asynchronous Execution</h2>
<p>Assuming the Iris kernel implements a lighter-weight execution mechanism than the <code>Task</code> object, there will be some more restrictions that need to be placed on these locking mechanisms.</p>
<h1><a class="anchor" id="autotoc_md186"></a>
Locking Mechanisms</h1>
<p>The most basic solution to solving these issues is to use some sort of lock. The called function will first aquire the lock before performing its logic, which ensures that race conditions are avoided.</p>
<h2><a class="anchor" id="autotoc_md187"></a>
Spinlock</h2>
<p>The most basic mechanism is the simple spinlock, whose locking operations is to repeatedly try to write a 1 to the lock itself. It can only do so when the lock is 0.</p>
<p>As mentioned above, a spinlock which protects execution during a HW interrupt must disable interrupts inside its body. As consequence, the Iris kernel defines 2 spinlock types: <code>Spinlock</code> and <code>InterruptibleSpinlock</code>. Since disabling IRQs is only a performance pessimization, the default will disable interrupts.</p>
<p>Assuming that HW IRQs can allocate memory, the internal heap and page frame allocators will need to use the interrupt disabling variants. On the other hand, locks related to tasks and scheduling can likely use the <code>InterruptibleSpinlock</code> type.</p>
<h2><a class="anchor" id="autotoc_md188"></a>
Mutex</h2>
<p>The primary issue with a spinlock is that it will never stop trying to aquire the lock, which means it can waste a large number of CPU cycles. This cost can be mitigated by having kernel level spinlocks prevent the running task from being pre-empted, but in case where there is a long critical section, it is likely ill-advised to use a spinlock.</p>
<p>A mutex internally has a queue of waiting tasks, and when the mutex is unlocked, the kernel will schedule exactly 1 task to execute, and this task is expected to acquire the lock.</p>
<p>A mutex cannot be used to synchronize with interrupt handlers, because interrupt handlers do not have an associated task object for which their execution can be queued. As such, anything accessible from interrupt handlers <b>MUST</b> use a <code>Spinlock</code>.</p>
<h2><a class="anchor" id="autotoc_md189"></a>
Note on Asynchronous Execution</h2>
<p>Assuming the Iris kernel implements a lighter-weight execution mechanism than the <code>Task</code> object, a different type of mutex will be needed, which operates on the level of a coroutine execution. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Iros Project Documentation</a></li><li class="navelem"><a class="el" href="md_docs_2iris_2table__of__contents.html">Iris Kernel Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>

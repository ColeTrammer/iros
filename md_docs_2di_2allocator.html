<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.10.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iros: Allocator</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- ... other metadata & script includes ... -->
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeParagraphLink.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init();
    </script>
  </head>
  <body>
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">
                    Iros
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2di_2allocator.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Allocator</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md14"></a> </p>
<h1><a class="anchor" id="autotoc_md15"></a>
Purpose</h1>
<p>Controlling the mechanism for allocating memory is very useful for performance sensitive applications. In particular, many functions require allocating memory, and must also consider the possibility of allocation failure. Additionally, since coroutines allocate memory in c++, a good allocator mechanism is needed.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Problem with Standard C++ Allocators</h1>
<p>The original model for the library is based directly on standard c++ allocators. However, there are a few problems with this approach.</p>
<ol type="1">
<li>Allocators are templated on a concrete type, which makes their use cumbersome.</li>
<li>As a direct result of (1), allocators cannot be type-erased.</li>
</ol>
<h1><a class="anchor" id="autotoc_md17"></a>
Allocator Interface</h1>
<p>The allocator interface provides a way to allocate memory, and to deallocate memory.</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T = <span class="keywordtype">void</span>&gt;</div>
<div class="line"><span class="keyword">struct </span>AllocationResult {</div>
<div class="line">    T* data;</div>
<div class="line">    usize count;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">concept </span>Allocator = <span class="keyword">requires</span>(T&amp; allocator, <span class="keywordtype">void</span>* ptr, usize <a class="code hl_variable" href="gfx__test_8cpp.html#ae34b142e980ed392b162c1e148e94daf">size</a>, usize alignment) {</div>
<div class="line">    { di::allocate(allocator, size, alignment) } -&gt; MaybeFallible&lt;AllocationResult&lt;&gt;&gt;;</div>
<div class="line">    di::deallocate(allocator, ptr, size, alignment);</div>
<div class="line">};</div>
<div class="ttc" id="agfx__test_8cpp_html_ae34b142e980ed392b162c1e148e94daf"><div class="ttname"><a href="gfx__test_8cpp.html#ae34b142e980ed392b162c1e148e94daf">size</a></div><div class="ttdeci">constexpr usize size</div><div class="ttdef"><b>Definition</b> gfx_test.cpp:17</div></div>
</div><!-- fragment --><p>The <code>allocate</code> function returns an <code>AllocationResult</code>, which contains the pointer to the allocated memory, and the actual size in bytes of the allocation. This is useful for allocators which may allocate more memory than requested, and can be used by <code>di::Vector</code> to determine the capacity of the vector. In addition, this operation is allowed to fail for any reason, but can optionally be infallible if the allocator asserts on failure.</p>
<p>The <code>deallocate</code> function is the inverse of <code>allocate</code>, and deallocates the memory at the given pointer. The size and alignment must be provided, which allows much more efficent implementations of <code>deallocate</code>.</p>
<p>Both functions are implemented as CPOs, which means that they can be defined in terms of member functions <code>allocate</code> and <code>deallocate</code> or using hidden-friend <code>tag_invoke</code> overloads, which means that they can be type-erased using <code>di::Any</code>.</p>
<p>Note that this concept specifies no constraints on the allocator's copy or move semantics. However, allocators which are used in containers have to consider these semantics. It is expected that a container will inherit the movability of its allocator, and will only be cloneable if its allocator is cloneable.</p>
<h1><a class="anchor" id="autotoc_md18"></a>
Allocator Usage</h1>
<p>These CPOs can be used directly, but more commonly, code wants to allocate or deallocate a specific type. This is done using the <code>di::allocate_many</code> and <code>di::allocate_one</code> functions, which have the following signatures:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">constexpr</span> MaybeFallible&lt;T*&gt; allocate_one(Allocator <span class="keyword">auto</span>&amp; allocator);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">constexpr</span> MaybeFallible&lt;AllocationResult&lt;T&gt;&gt; allocate_many(Allocator <span class="keyword">auto</span>&amp; allocator, usize count);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">void</span> deallocate_one(Allocator <span class="keyword">auto</span>&amp; allocator, T* ptr);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">constexpr</span> <span class="keywordtype">void</span> deallocate_many(Allocator <span class="keyword">auto</span>&amp; allocator, T* ptr, usize count);</div>
</div><!-- fragment --><p>These functions call to the underlying byte-allocation strategy, and then cast the pointer to the appropriate type. When called in a constant-evaulated context, these functions will use <code>std::allocator&lt;T&gt;</code> instead of the passed allocator, since this is the only way to support constexpr allocation.</p>
<h1><a class="anchor" id="autotoc_md19"></a>
Allocator Interaction with Containers</h1>
<p>All owning containers in the library have an allocator type parameter. The biggest question when using allocators is what to do when moving out of a container. The library has two options for this:</p>
<ol type="1">
<li>The container can move the values into memory allocated by the new container's allocator.</li>
<li>The container can move the simply move the old allocator into the new container.</li>
</ol>
<p>The first option is what is chosen by the standard polymorphic allocators, but is not what is chosen by the library. This is probably because option 2 requires type-erasing a move operation, and additionally makes inline storage in a memory resource impossible. Furthermore, standard allocators are meant to have "reference" semantics. However, since this library supports type-erasure already, as well as static vectors, option 2 is chosen. This results in a lot more intuitive behavior, and prevents needless allocation. On the other hand, this introduces safety issues, since the container's allocator may need to be re-initialized after being moved out of. As a consequence, allocators which have "destuctive" moves should be fallible, and should return an error if an allocation occurs in this state.</p>
<h1><a class="anchor" id="autotoc_md20"></a>
Conceptual Example</h1>
<div class="fragment"><div class="line"><span class="keyword">auto</span> pool = di::make_pool_allocator(8192);</div>
<div class="line"><span class="keyword">auto</span> vector = di::Vector&lt;int, di::AnyInline&lt;di::Allocator&gt;&gt;(di::move(pool));</div>
<div class="line"> </div>
<div class="line"><a class="code hl_define" href="monad__try_8h.html#ad2746371528bdf15c3910b7bf217dac0">TRY</a>(vector.push_back(1));</div>
<div class="line"><a class="code hl_define" href="monad__try_8h.html#ad2746371528bdf15c3910b7bf217dac0">TRY</a>(vector.push_back(2));</div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> new_vector = di::move(vector);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This is using the same allocator as the old vector.</span></div>
<div class="line"><a class="code hl_define" href="monad__try_8h.html#ad2746371528bdf15c3910b7bf217dac0">TRY</a>(new_vector.push_back(3));</div>
<div class="line"><a class="code hl_define" href="assert__binary_8h.html#ab601785d192462f8e12893f57052b29a">ASSERT_EQ</a>(new_vector.size(), 3);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Allocation to the pool allocator is not allowed after moving out of it.</span></div>
<div class="line"><a class="code hl_define" href="assert__bool_8h.html#af343b20373ba49a92fce523e948f2ab3">ASSERT</a>(!vector.push_back(2));</div>
<div class="ttc" id="aassert__binary_8h_html_ab601785d192462f8e12893f57052b29a"><div class="ttname"><a href="assert__binary_8h.html#ab601785d192462f8e12893f57052b29a">ASSERT_EQ</a></div><div class="ttdeci">#define ASSERT_EQ</div><div class="ttdef"><b>Definition</b> assert_binary.h:78</div></div>
<div class="ttc" id="aassert__bool_8h_html_af343b20373ba49a92fce523e948f2ab3"><div class="ttname"><a href="assert__bool_8h.html#af343b20373ba49a92fce523e948f2ab3">ASSERT</a></div><div class="ttdeci">#define ASSERT</div><div class="ttdef"><b>Definition</b> assert_bool.h:16</div></div>
<div class="ttc" id="amonad__try_8h_html_ad2746371528bdf15c3910b7bf217dac0"><div class="ttname"><a href="monad__try_8h.html#ad2746371528bdf15c3910b7bf217dac0">TRY</a></div><div class="ttdeci">#define TRY</div><div class="ttdef"><b>Definition</b> monad_try.h:23</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Iros Project Documentation</a></li><li class="navelem"><a class="el" href="md_docs_2di_2table__of__contents.html">Di Library Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>

<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=11" />
    <meta name="generator" content="Doxygen 1.10.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iros: Linux Startup</title>
    <link href="tabs.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
 <script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
    <link href="doxygen.css" rel="stylesheet" type="text/css" />
    <link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
    <!-- ... other metadata & script includes ... -->
    <script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeDarkModeToggle.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeFragmentCopyButton.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeParagraphLink.init();
    </script>
    <script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
    <script type="text/javascript">
      DoxygenAwesomeInteractiveToc.init();
    </script>
  </head>
  <body>
      <div id="top">
        <!-- do not remove this div, it is closed by doxygen! -->
        <div id="titlearea">
          <table cellspacing="0" cellpadding="0">
            <tbody>
              <tr id="projectrow">
                <td id="projectalign">
                  <div id="projectname">
                    Iros
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_docs_2dius_2linux__startup.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Linux Startup</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md101"></a> This document describes the required steps and ABI used to start a Linux executable, from the perspective of the C/C++ runtime. This assumes a statically linked executable for now.</p>
<h1><a class="anchor" id="autotoc_md102"></a>
Entry</h1>
<p>The entry point for the program is the is the symbol <code>_start</code>. argc, argv, and envp are arranged on the stack as follows.</p>
<div class="fragment"><div class="line">+----------------+</div>
<div class="line">| ...            |</div>
<div class="line">| elf aux vec    |</div>
<div class="line">+----------------+</div>
<div class="line">| null           |</div>
<div class="line">| ...            |</div>
<div class="line">| envp[0]        | &lt;- rsp + 8 * (argc + 2)</div>
<div class="line">+----------------+</div>
<div class="line">| null           | &lt;- rsp + 8 * (argc + 1)</div>
<div class="line">| argv[argc - 1] |</div>
<div class="line">| ...            |</div>
<div class="line">| argv[0]        | &lt;- rsp + 8</div>
<div class="line">+----------------+</div>
<div class="line">| argc           | &lt;- rsp</div>
<div class="line">+----------------+</div>
</div><!-- fragment --><p>In particular, the stack is setup such that the top of the stack is argc, and the next 8 byte word is argv. This is null terminated, and the envp follows. After the envp, comes the ELF auxillary vector, which contains extra information from the Linux kernel.</p>
<h1><a class="anchor" id="autotoc_md103"></a>
Startup Steps</h1>
<ol type="1">
<li>Zero the stack base pointer</li>
<li>Setup argc and argv by placing into registers</li>
<li>Ensure the stack is 16 byte aligned</li>
<li>Call into c++ initialization code</li>
<li>Setup thread-local storage</li>
<li>Call global constructors</li>
<li>Call main</li>
</ol>
<h1><a class="anchor" id="autotoc_md104"></a>
Setup Thread-Local Storage</h1>
<p>Setting up thread-local storage involves allocating some specific memory area with correct alignment, setting up a thread control block, and calling <code>arch_prctl(ARCH_SET_FS)</code> pointing to the middle of this memory area. The challenging part is to figure out where and and how large the <code>TLS</code> segment is. On Linux, this requires parsing the program's own ELF program headers. For a statically linked executable, this can be done by following the magic <code>__ehdr_start</code> symbol, which points to the program's own ELF header. From there, the runtime must identify if a <code>TLS</code> type segment is present, and if so, reserve space for the segment.</p>
<p>If this is managed, thread-local storage can be allocated as described on <a href="https://wiki.osdev.org/Thread_Local_Storage">OSDev</a>. However, the exact algorithm used is wrong. In particular, the TLS data block is always directly before the thread control block, regardless of alignment.</p>
<h2><a class="anchor" id="autotoc_md105"></a>
Is There Anything Simpler?</h2>
<p>The Linux kernel provides an auxillary vector which contains extra program information. But this vector does not contain any information about the thread-local storage segment. It does provide another way to access the program's own program headers, but I do not know if this entry is present for statically linked executables. It could only be present if a program header entry of type <code>PHDR</code> is present in the ELF binary.</p>
<p>Presumably, this configuration is required because the Linux kernel predates the invention of thread local storage. As such, there was a goal to minimize the need for kernel changes when adopting this new feature. This partially makes sense, because it is up to userspace to ultimately manage the thread-local storage. And things get even more complicated when considering dynamic linking, because multiple libraries can allocate their thread-local regions. Additionally, access to the program headers is somewhat mandated by the <code>dl_iterator_phdr</code> function, which is used to unwind the stack by libunwind. If userspace has to parse its own program headers anyway, why should Linux change its ABI?</p>
<p>It is tempting to have the Iris kernel provide userspace with the TLS base, TLS alignment, and TLS size based on the loaded executable. However, this does open up some questions, like: What happens if there are multiple TLS segments? What happens if the dynamic linker requests TLS? Given that the dius runtime will already support the ABI present on Linux, it will be easier to just ignore TLS in the kernel. This aligns which its minimalist philosophy. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Iros Project Documentation</a></li><li class="navelem"><a class="el" href="md_docs_2dius_2table__of__contents.html">Dius Library Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0 </li>
  </ul>
</div>
</body>
</html>
